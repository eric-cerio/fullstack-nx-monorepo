---
name: nextjs-patterns
description: Next.js 15 patterns for the Nx monorepo frontend apps. Covers App Router, Server/Client Components, Clerk middleware, shadcn/ui usage, and multi-app architecture.
---

# Next.js 15 Patterns

## App Router Structure (Per App)

```
apps/admin/src/
├── app/
│   ├── layout.tsx          # Root layout with ClerkProvider
│   ├── page.tsx            # Dashboard home
│   ├── (auth)/
│   │   ├── sign-in/page.tsx
│   │   └── sign-up/page.tsx
│   ├── users/
│   │   ├── page.tsx        # Users list (Server Component)
│   │   └── [id]/page.tsx   # User detail
│   └── settings/
│       └── page.tsx
├── components/
│   └── ui/                 # shadcn/ui components (per-app)
├── middleware.ts            # Clerk auth middleware
└── lib/
    └── api.ts              # API client for NestJS backend
```

## Server vs Client Components

```typescript
// ✅ Server Component (default) — for data fetching
// apps/admin/src/app/users/page.tsx
export default async function UsersPage() {
  const users = await fetch('http://localhost:4000/api/users', {
    headers: { Authorization: `Bearer ${await getToken()}` },
  }).then(r => r.json())

  return <UserTable users={users.data} />
}

// ✅ Client Component — for interactivity
// apps/admin/src/components/UserTable.tsx
'use client'

import { useState } from 'react'
import { DataTable } from '@/components/ui/data-table'

export function UserTable({ users }: { users: User[] }) {
  const [search, setSearch] = useState('')
  // Interactive logic...
}
```

## Clerk Middleware (Per App)

```typescript
// apps/admin/src/middleware.ts
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

const isProtectedRoute = createRouteMatcher(['/(.*)'])
const isPublicRoute = createRouteMatcher(['/sign-in(.*)', '/sign-up(.*)'])

export default clerkMiddleware(async (auth, req) => {
  if (isPublicRoute(req)) return

  if (isProtectedRoute(req)) {
    await auth.protect()

    // Role check for admin app
    const { sessionClaims } = await auth()
    const role = sessionClaims?.metadata?.role

    if (role !== 'admin') {
      return new Response('Forbidden', { status: 403 })
    }
  }
})

export const config = {
  matcher: ['/((?!.*\\..*|_next).*)', '/', '/(api|trpc)(.*)'],
}
```

## API Client Pattern

```typescript
// apps/admin/src/lib/api.ts
import { auth } from '@clerk/nextjs/server'

const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4000'

export async function apiClient<T>(
  path: string,
  options?: RequestInit
): Promise<ApiResponse<T>> {
  const { getToken } = await auth()
  const token = await getToken()

  const response = await fetch(`${API_BASE}${path}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
      ...options?.headers,
    },
  })

  return response.json()
}
```

## shadcn/ui Usage

Each app has its own `components/ui/` directory:
```bash
# Add component to specific app
cd apps/admin && npx shadcn@latest add button
cd apps/partner && npx shadcn@latest add button
```

```typescript
// apps/admin/src/components/ui/button.tsx — generated by shadcn
// Import within the same app only
import { Button } from '@/components/ui/button'
```

## Layout with ClerkProvider

```typescript
// apps/admin/src/app/layout.tsx
import { ClerkProvider } from '@clerk/nextjs'

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body>
          <Sidebar />
          <main>{children}</main>
        </body>
      </html>
    </ClerkProvider>
  )
}
```

**Android Comparison**: Next.js App Router pages are like Android Activities. Layouts are like base Activities with shared UI. Server Components are like fetching data in a ViewModel before the screen renders. Client Components are like Fragments with interactive UI. Clerk middleware is like Android's auth interceptor in OkHttp.
